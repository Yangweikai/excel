<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelç¿»è¯‘å·¥å…· - æ¸…æ–°ç‰ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 25px 30px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .card-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #74b9ff;
            box-shadow: 0 0 0 3px rgba(116, 185, 255, 0.1);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            border: 2px dashed #74b9ff;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .file-upload-label:hover {
            border-color: #0984e3;
            background: #e3f2fd;
        }

        .file-upload-label i {
            font-size: 2rem;
            color: #74b9ff;
            margin-bottom: 10px;
            display: block;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(116, 185, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 184, 148, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #74b9ff 0%, #0984e3 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .status-info {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #74b9ff;
        }

        .status-info h4 {
            margin-bottom: 10px;
            color: #2d3436;
        }

        .status-info p {
            margin-bottom: 5px;
            color: #636e72;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #00b894;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #74b9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .download-section {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excelç¿»è¯‘å·¥å…·</h1>
            <p>æ™ºèƒ½ä¸­è‹±æ–‡ç¿»è¯‘ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†Excelæ–‡ä»¶</p>
        </div>

        <div class="main-card">
            <div class="card-header">
                ğŸ“ æ–‡ä»¶ä¸Šä¼ ä¸é…ç½®
            </div>
            <div class="card-body">
                <form id="translationForm">
                    <!-- æ–‡ä»¶ä¸Šä¼  -->
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©Excelæ–‡ä»¶</label>
                        <div class="file-upload">
                            <input type="file" id="excelFile" accept=".xlsx" required>
                            <label for="excelFile" class="file-upload-label">
                                <i>ğŸ“„</i>
                                <span id="fileLabel">ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶ (.xlsx)</span>
                            </label>
                        </div>
                    </div>

                    <!-- APIé…ç½® -->
                    <div class="grid">
                        <div class="form-group">
                            <label class="form-label">ç™¾åº¦ç¿»è¯‘ App ID</label>
                            <input type="text" id="appId" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„ç™¾åº¦ç¿»è¯‘App ID" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç™¾åº¦ç¿»è¯‘ App Key</label>
                            <input type="password" id="appKey" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„ç™¾åº¦ç¿»è¯‘App Key" required>
                        </div>
                    </div>

                    <!-- ç¿»è¯‘é…ç½® -->
                    <div class="grid">
                        <div class="form-group">
                            <label class="form-label">èµ·å§‹è¡Œ</label>
                            <input type="number" id="startRow" class="form-control" value="2" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç»“æŸè¡Œ</label>
                            <input type="number" id="endRow" class="form-control" placeholder="ç•™ç©ºè¡¨ç¤ºåˆ°æœ«å°¾">
                        </div>
                    </div>

                    <!-- å·¥ä½œè¡¨é€‰æ‹© -->
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©å·¥ä½œè¡¨</label>
                        <div id="sheetSelection" class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="selectAll" checked>
                                <label for="selectAll">å…¨é€‰</label>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ—é€‰æ‹© -->
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©è¦ç¿»è¯‘çš„åˆ—</label>
                        <div id="columnSelection" class="checkbox-group">
                            <!-- åŠ¨æ€ç”Ÿæˆåˆ—é€‰é¡¹ -->
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" id="startBtn" class="btn btn-primary">
                            <span id="startBtnText">ğŸš€ å¼€å§‹ç¿»è¯‘</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="main-card" id="progressCard">
            <div class="card-header">
                ğŸ“ˆ ç¿»è¯‘è¿›åº¦
            </div>
            <div class="card-body">
                <div class="progress-container" id="progressContainer">
                    <div class="progress-text">
                        <span>ç¿»è¯‘è¿›åº¦</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    
                    <div class="status-info">
                        <h4>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h4>
                        <p>æ€»å•å…ƒæ ¼æ•°: <span id="totalCells">0</span></p>
                        <p>éœ€è¦ç¿»è¯‘: <span id="translatableCells">0</span></p>
                        <p>å·²ç¿»è¯‘: <span id="translatedCells">0</span></p>
                        <p>å·²è·³è¿‡: <span id="skippedCells">0</span></p>
                        <p>é”™è¯¯: <span id="errorCells">0</span></p>
                        <p>å½“å‰å·¥ä½œè¡¨: <span id="currentSheet">-</span></p>
                        <p>å½“å‰å•å…ƒæ ¼: <span id="currentCell">-</span></p>
                        <p>è€—æ—¶: <span id="elapsedTime">0ç§’</span></p>
                    </div>
                    
                    <div class="status-info">
                        <h4>ğŸ’¬ çŠ¶æ€ä¿¡æ¯</h4>
                        <p id="statusMessage">å‡†å¤‡å°±ç»ª</p>
                    </div>
                </div>

                <div class="download-section hidden" id="downloadSection">
                    <h3>âœ… ç¿»è¯‘å®Œæˆï¼</h3>
                    <p>æ‚¨çš„æ–‡ä»¶å·²æˆåŠŸç¿»è¯‘å®Œæˆï¼Œå¯ä»¥ä¸‹è½½äº†ã€‚</p>
                    <a href="#" id="downloadBtn" class="btn btn-success">ğŸ“¥ ä¸‹è½½ç¿»è¯‘åçš„æ–‡ä»¶</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let progressInterval = null;
        let uploadedFilePath = null; // å­˜å‚¨ä¸Šä¼ åçš„æ–‡ä»¶è·¯å¾„

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileLabel').textContent = file.name;
                uploadFile(file);
            }
        });

        // å…¨é€‰/å–æ¶ˆå…¨é€‰å·¥ä½œè¡¨
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('input[name="sheets"]');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });

        // è¡¨å•æäº¤
        document.getElementById('translationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            startTranslation();
        });

        // ä¸Šä¼ æ–‡ä»¶
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
                    uploadedFilePath = data.filepath; // ä¿å­˜æ–‡ä»¶è·¯å¾„
                    populateSheetSelection(data.sheet_names);
                    populateColumnSelection(data.columns);
                } else {
                    showAlert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showAlert('ä¸Šä¼ å‡ºé”™: ' + error.message, 'error');
            });
        }

        // å¡«å……å·¥ä½œè¡¨é€‰æ‹©
        function populateSheetSelection(sheetNames) {
            const container = document.getElementById('sheetSelection');
            container.innerHTML = '<div class="checkbox-item"><input type="checkbox" id="selectAll" checked><label for="selectAll">å…¨é€‰</label></div>';
            
            sheetNames.forEach(sheet => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" name="sheets" value="${sheet}" checked>
                    <label>${sheet}</label>
                `;
                container.appendChild(div);
            });

            // é‡æ–°ç»‘å®šå…¨é€‰äº‹ä»¶
            document.getElementById('selectAll').addEventListener('change', function(e) {
                const checkboxes = document.querySelectorAll('input[name="sheets"]');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
        }

        // å¡«å……åˆ—é€‰æ‹©
        function populateColumnSelection(columns) {
            const container = document.getElementById('columnSelection');
            container.innerHTML = '';
            
            columns.forEach(col => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" name="columns" value="${col}">
                    <label>${col}</label>
                `;
                container.appendChild(div);
            });
        }

        // å¼€å§‹ç¿»è¯‘
        function startTranslation() {
            if (!uploadedFilePath) {
                showAlert('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'warning');
                return;
            }

            const formData = {
                filepath: uploadedFilePath, // ä½¿ç”¨å®Œæ•´çš„æ–‡ä»¶è·¯å¾„
                app_id: document.getElementById('appId').value,
                app_key: document.getElementById('appKey').value,
                start_row: parseInt(document.getElementById('startRow').value) || 1,
                end_row: parseInt(document.getElementById('endRow').value) || null,
                sheet_names: Array.from(document.querySelectorAll('input[name="sheets"]:checked')).map(cb => cb.value),
                columns: Array.from(document.querySelectorAll('input[name="columns"]:checked')).map(cb => cb.value)
            };

            if (formData.sheet_names.length === 0) {
                showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå·¥ä½œè¡¨', 'warning');
                return;
            }

            if (formData.columns.length === 0) {
                showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—è¿›è¡Œç¿»è¯‘', 'warning');
                return;
            }

            // ç¦ç”¨å¼€å§‹æŒ‰é’®
            const startBtn = document.getElementById('startBtn');
            const startBtnText = document.getElementById('startBtnText');
            startBtn.disabled = true;
            startBtnText.innerHTML = '<span class="loading"></span> å¯åŠ¨ä¸­...';

            fetch('/start_translation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentTaskId = data.task_id;
                    showProgress();
                    startProgressPolling();
                } else {
                    showAlert('å¯åŠ¨ç¿»è¯‘å¤±è´¥: ' + data.error, 'error');
                    resetStartButton();
                }
            })
            .catch(error => {
                showAlert('å¯åŠ¨å‡ºé”™: ' + error.message, 'error');
                resetStartButton();
            });
        }

        // æ˜¾ç¤ºè¿›åº¦
        function showProgress() {
            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('downloadSection').classList.add('hidden');
            
            // é‡ç½®è¿›åº¦æ¡çŠ¶æ€
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').style.background = 'linear-gradient(90deg, #74b9ff 0%, #0984e3 100%)';
            document.getElementById('totalCells').textContent = '0';
            document.getElementById('translatableCells').textContent = '0';
            document.getElementById('translatedCells').textContent = '0';
            document.getElementById('skippedCells').textContent = '0';
            document.getElementById('errorCells').textContent = '0';
            document.getElementById('currentSheet').textContent = '-';
            document.getElementById('currentCell').textContent = '-';
            document.getElementById('elapsedTime').textContent = '0ç§’';
            document.getElementById('statusMessage').textContent = 'æ­£åœ¨å¯åŠ¨ç¿»è¯‘ä»»åŠ¡...';
        }

        // å¼€å§‹è½®è¯¢è¿›åº¦
        function startProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            progressInterval = setInterval(() => {
                if (currentTaskId) {
                    fetch(`/progress/${currentTaskId}`)
                        .then(response => response.json())
                        .then(data => {
                            updateProgress(data);
                            
                            if (data.status === 'completed' || data.status === 'failed') {
                                clearInterval(progressInterval);
                                if (data.status === 'completed') {
                                    showDownloadSection(data.output_file);
                                }
                                resetStartButton();
                            }
                        })
                        .catch(error => {
                            console.error('è·å–è¿›åº¦å¤±è´¥:', error);
                        });
                }
            }, 1000);
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(data) {
            // æ›´æ–°è¿›åº¦æ¡
            let progressPercent = data.progress || 0;
            // ç¡®ä¿è¿›åº¦ä¸è¶…è¿‡100%
            progressPercent = Math.min(100, Math.max(0, progressPercent));
            
            document.getElementById('progressPercent').textContent = progressPercent + '%';
            document.getElementById('progressFill').style.width = progressPercent + '%';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const totalCells = data.total_cells || 0;
            const translatedCells = data.translated_cells || 0;
            const skippedCells = data.skipped_cells || 0;
            const errorCells = data.error_cells || 0;
            
            // è®¡ç®—éœ€è¦ç¿»è¯‘çš„å•å…ƒæ ¼æ•°ï¼ˆæ€»å•å…ƒæ ¼æ•° - å·²è·³è¿‡çš„ï¼‰
            const translatableCells = totalCells - skippedCells;
            
            document.getElementById('totalCells').textContent = totalCells;
            document.getElementById('translatableCells').textContent = translatableCells;
            document.getElementById('translatedCells').textContent = translatedCells;
            document.getElementById('skippedCells').textContent = skippedCells;
            document.getElementById('errorCells').textContent = errorCells;
            document.getElementById('currentSheet').textContent = data.current_sheet || '-';
            document.getElementById('currentCell').textContent = data.current_cell || '-';
            document.getElementById('elapsedTime').textContent = (data.elapsed_time || 0) + 'ç§’';
            
            // è®¡ç®—ç¿»è¯‘è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆåªè€ƒè™‘å®é™…ç¿»è¯‘çš„å•å…ƒæ ¼ï¼‰
            const actualTranslated = translatedCells + errorCells;
            
            let translationProgress = 0;
            if (translatableCells > 0) {
                translationProgress = Math.min(100, Math.round((actualTranslated / translatableCells) * 100));
            }
            
            // æ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼Œæ˜¾ç¤ºç¿»è¯‘è¿›åº¦
            let statusMessage = data.message || 'å¤„ç†ä¸­...';
            if (data.status === 'running' && translatableCells > 0) {
                statusMessage += ` | ç¿»è¯‘è¿›åº¦: ${translationProgress}%`;
            }
            document.getElementById('statusMessage').textContent = statusMessage;
            
            // æ ¹æ®çŠ¶æ€æ›´æ–°è¿›åº¦æ¡é¢œè‰²
            const progressFill = document.getElementById('progressFill');
            if (data.status === 'failed') {
                progressFill.style.background = 'linear-gradient(90deg, #e74c3c 0%, #c0392b 100%)';
            } else if (data.status === 'completed') {
                progressFill.style.background = 'linear-gradient(90deg, #00b894 0%, #00a085 100%)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #74b9ff 0%, #0984e3 100%)';
            }
            
            // è°ƒè¯•ä¿¡æ¯
            if (progressPercent > 100) {
                console.warn('è¿›åº¦å¼‚å¸¸:', {
                    progress: data.progress,
                    totalCells: totalCells,
                    translatableCells: translatableCells,
                    translatedCells: translatedCells,
                    skippedCells: skippedCells,
                    errorCells: errorCells,
                    translationProgress: translationProgress
                });
            }
        }

        // æ˜¾ç¤ºä¸‹è½½åŒºåŸŸ
        function showDownloadSection(outputFile) {
            document.getElementById('downloadSection').classList.remove('hidden');
            document.getElementById('downloadBtn').href = `/download/${currentTaskId}`;
            showAlert('ç¿»è¯‘å®Œæˆï¼å¯ä»¥ä¸‹è½½æ–‡ä»¶äº†ã€‚', 'success');
        }

        // é‡ç½®å¼€å§‹æŒ‰é’®
        function resetStartButton() {
            const startBtn = document.getElementById('startBtn');
            const startBtnText = document.getElementById('startBtnText');
            startBtn.disabled = false;
            startBtnText.innerHTML = 'ğŸš€ å¼€å§‹ç¿»è¯‘';
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>